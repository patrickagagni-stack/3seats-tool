<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Data Import Tool</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script async defer src="https://apis.google.com/js/api.js"></script>
  <script async defer src="https://accounts.google.com/gsi/client"></script>
  <style>
    :root{ --bg:#0b1020; --panel:#141a2f; --muted:#b7c4ff; --text:#f5f8ff; --warn:#ffb020; --err:#ff6b6b; --ok:#32d583; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 20px;border-bottom:1px solid #1f2745;background:linear-gradient(180deg,#0e1530,#0b1020)}
    h1{margin:0;font-size:20px}
    main{padding:20px;max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:16px}
    .card{background:var(--panel);border:1px solid #1f2745;border-radius:16px;box-shadow:0 6px 30px #0006}
    .card h2{margin:0;padding:14px 16px;font-size:16px;border-bottom:1px solid #1f2745;color:#dbe3ff}
    .card .content{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input[type="file"], select, input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243058;background:#0e1429;color:#fff}
    select option{background:#0e1429;color:#fff}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;border:1px solid #2b3761;background:#162048;color:#f5f8ff;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(180deg,#3957d8,#2d47b5)}
    .row{display:flex;gap:12px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid #29335a;border-radius:999px;color:#dbe3ff;background:#0f1735;font-size:12px}
    .pill.required{background:#0f1735;border-color:#2b3a7a;color:#ff9090;font-size:10px;padding:2px 6px;margin-left:6px}
    .pill.offsite{background:#2a210e;border-color:#8a6b00;color:#ffd78a;font-size:10px;padding:2px 6px;margin-left:6px}
    .hint{font-size:11px;color:#aab8f5}
    .notice{border-left:4px solid var(--warn);background:#2a210e;padding:10px 12px;border-radius:8px;color:#ffd78a}
    .danger{border-left:4px solid var(--err);background:#2a1414;padding:10px 12px;border-radius:8px;color:#ffb3b3}
    .success{border-left:4px solid var(--ok);background:#142a1f;padding:10px 12px;border-radius:8px;color:#b3ffcc}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid #202a55}
    th{position:sticky;top:0;background:#121a34;text-align:left;font-size:12px;color:#c8d4ff}
    .mapping-row{display:grid;grid-template-columns:260px 1fr 220px 220px;gap:10px;align-items:center}
    .disabled-cell{opacity:.5;pointer-events:none}
    .rooms-wrap{display:flex;flex-wrap:wrap;gap:8px}
    .room-chip{padding:6px 10px;border:1px solid #29335a;border-radius:999px;background:#0f1735;color:#f5f8ff;font-size:12px}
    .dropzone{border:2px dashed #2b3761;border-radius:12px;padding:20px;text-align:center;background:#0f1735;color:#c8d4ff;position:relative}
    .dropzone.dragover{background:#122048}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 12px;border-radius:10px;background:#122048;border:1px solid #2b3761;color:#e7ecff;box-shadow:0 6px 30px #000a;display:none}
    .visually-hidden{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
  </style>
</head>
<body>
  <header>
    <h1>Event Data Import Tool</h1>
    <div class="hint" style="margin-top:6px">Upload/Preview, Field Mapping, Rooms, optional Status, Room & Owner mapping, and Export.</div>
    <div class="hint" style="margin-top:4px">Last updated: October 16, 2025 - Fixed Google Sheets Export</div>
  </header>

  <main class="grid">
    <section class="card"><h2>1) Upload Customer Data (Excel/CSV)</h2><div class="content grid" style="gap:10px">
      <div id="drop" class="dropzone" tabindex="0" role="button" aria-label="Upload customer file">Drop file here or click to browse
        <input id="overlayPicker" type="file" accept=".xlsx,.xls,.csv" aria-hidden="true" style="position:absolute;inset:0;opacity:0;cursor:pointer" />
      </div>
      <input id="customerFile" type="file" accept=".xlsx,.xls,.csv" class="visually-hidden" />
      <div class="row wrap" id="customerMeta" style="display:none;gap:8px"></div>
      <div class="row wrap" style="gap:8px;margin-top:8px"><span class="pill">Preview rows: <span id="previewCount">0</span></span><button class="btn" id="togglePreview" disabled>Show Preview</button></div>
      <div id="preview" style="display:none;margin-top:10px;max-height:300px;overflow:auto"><table id="previewTable"></table></div>
    </div></section>

    <section class="card"><h2>2) Map Fields</h2><div class="content">
      <div class="notice" id="mappingNotice">Columns marked <span class="pill required">required</span> allow a default that is used only if the source is blank. Off-site fields are marked with <span class="pill offsite">Off-Site</span>.</div>
      <div id="mappingArea" style="display:none" class="grid">
        <div class="mapping-row" style="font-size:12px;color:#8ea0dc;margin-bottom:4px"><div>Master Header</div><div>Source (Customer Field)</div><div>Format Conversions (As Needed)</div><div>Default / Constant</div></div>
        <div id="mappingRows" class="grid" style="gap:8px"></div>
      </div>
      <div class="row wrap" style="gap:8px;margin-top:10px">
        <button class="btn" id="saveMapping" type="button">Save Mapping</button>
        <button class="btn" id="loadMapping" type="button">Load Mapping</button>
      </div>
    </div></section>

    <section class="card"><h2>3) Rooms summary</h2><div class="content">
      <div class="row wrap">
        <span class="pill">Unique rooms: <span id="roomsCount">0</span></span>
        <label class="rooms-input"><span class="hint">Room separator characters</span><input id="roomSeps" type="text" value=",/;|:" /></label>
        <button class="btn" id="refreshRooms">Refresh</button>
        <button class="btn" id="copyRooms">Copy list</button>
      </div>
      <div class="rooms-wrap" id="roomsList" style="margin-top:8px"></div>
    </div></section>

    <section class="card"><h2>4) Status mapping</h2><div class="content">
      <div class="notice">Optional. If disabled, statuses export unchanged.</div>
      <div class="row wrap" style="gap:8px;margin-bottom:8px"><button class="btn" id="toggleStatusMap">Enable status mapping</button><span class="hint">Collapsed by default</span></div>
      <div id="statusMapArea" style="display:none">
        <div class="row wrap" style="gap:8px;align-items:flex-end;margin-bottom:10px">
          <label style="min-width:260px">
            <span class="hint">Default canonical status for all (optional)</span>
            <select id="statusDefault">
              <option value="">— No default —</option>
              <option value="Prospect">Prospect</option>
              <option value="Tentative">Tentative</option>
              <option value="Definite">Definite</option>
              <option value="Closed">Closed</option>
              <option value="Lost">Lost</option>
            </select>
          </label>
          <button class="btn" id="applyStatusDefaultAll" type="button">Apply default to all</button>
        </div>
        <div class="hint" style="margin-bottom:8px">Detected statuses (left) → Canonical (right)</div>
        <div id="statusMapRows" class="grid" style="gap:8px"></div>
        <div class="row wrap" style="gap:8px;margin-top:8px"><button class="btn" id="saveStatusMap">Save Status Mapping</button><button class="btn" id="loadStatusMap">Load Status Mapping</button></div>
      </div>
    </div></section>

    <section class="card"><h2>5) Room mapping</h2><div class="content">
      <div class="notice">Optional. If disabled, room values export unchanged.</div>
      <div class="row wrap" style="gap:8px;margin-bottom:8px"><button class="btn" id="toggleRoomMap">Enable room mapping</button><span class="hint">Uses Excel-like Find & Replace</span></div>
      <div id="roomMapArea" style="margin-top:10px; display:none">
        <div class="hint" style="margin-bottom:8px">Detected rooms (left) → Action (right)</div>
        <div id="roomMapRows" class="grid" style="gap:8px"></div>
      </div>
    </div></section>

    <section class="card"><h2>6) Owner mapping</h2><div class="content">
      <div class="notice">Optional. If disabled, owners export unchanged.</div>
      <div class="row wrap" style="gap:8px;margin-bottom:8px"><button class="btn" id="toggleOwnerMap">Enable owner mapping</button><span class="hint">Collapsed by default</span></div>
      <div id="ownerMapArea" style="margin-top:10px; display:none">
        <div class="hint" style="margin-bottom:8px">Detected owners (left) → Action (right)</div>
        <div id="ownerMapRows" class="grid" style="gap:8px"></div>
      </div>
    </div></section>

    <section class="card"><h2>7) Export</h2><div class="content">
      <div class="row wrap" style="gap:12px">
        <label><span>Output Sheet Name</span><input id="sheetName" type="text" placeholder="Defaults to Events"/></label>
        <label><span>File Name</span><input id="fileName" type="text" placeholder="master_output.xlsx"/></label>
        <label><span>Room Separator <span class="hint">(in most cases should match section 3)</span></span><input id="roomSep" type="text" value=","/></label>
        <label><span>Replace room separators</span>
          <div class="row" style="gap:8px">
            <select id="roomSepMode">
              <option value="leave" selected>Leave as is</option>
              <option value="replace">Replace with…</option>
            </select>
            <input id="roomSepReplace" type="text" value=", " placeholder=", " disabled />
          </div>
        </label>
        <label><span>Export Format</span><select id="exportFormat"><option value="xlsx" selected>.xlsx (Excel)</option><option value="csv">.csv</option></select></label>
        <label class="row" style="gap:8px"><input id="appendExtras" type="checkbox" checked/><span class="hint">Append unmatched customer columns</span></label>
        <label class="row" style="gap:8px"><input id="includeRoomsSheet" type="checkbox" checked/><span class="hint">Include a separate "Lists" sheet</span></label>
        <button class="btn primary" id="exportBtn" disabled>Generate</button>
        <button class="btn" id="exportToSheetsBtn" type="button" title="Create a Google Sheet from the current preview/mapping" style="margin-left:8px;">Export to Google Sheet</button>
      </div>
      <div id="exportMsg" style="margin-top:10px"></div>
    </div></section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
// [CONTINUED IN PART 2 - File is too large for one message]
// The download will include the complete file with all JavaScript
  </script>
</body>
</html>