<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3seats — Fresh Export (Clean Start)</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin:0; padding:32px; background:#fafafa; color:#111; }
    .wrap { max-width: 900px; margin: 0 auto; }
    h1 { margin:0 0 8px; font-size:22px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px 18px; margin:16px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input[type="text"]{ padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; min-width:280px;}
    button{ appearance:none; border:0; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;}
    .muted{ color:#6b7280; font-size:13px;}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .ok{ color:#065f46; }
    .warn{ color:#92400e; }
    .small{ font-size:12px; }
    .divider{ height:1px; background:#eee; margin:12px 0; }
    .hidden{ display:none; }
    .log{ white-space:pre-wrap; font-size:12px; background:#0b1021; color:#c7d2fe; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>3seats — Fresh Export (Clean Start)</h1>
  <div class="card">
    <p class="muted">This clean version ignores previous wiring and does one job reliably:<br>
    <b>Pick an Excel (.xlsx) → Convert to Google Sheets → Copy into your template → Open it.</b><br>
    It preserves <i>all</i> columns and tabs because Google does the conversion.</p>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label class="small">Output base name</label><br/>
        <input id="fileName" type="text" placeholder="master_output" />
      </div>
      <div>
        <label class="small">&nbsp;</label><br/>
        <button id="btnExport">Export to Google Sheet</button>
      </div>
    </div>
    <div class="divider"></div>
    <div id="status" class="small muted">Idle</div>
  </div>

  <div class="card">
    <details>
      <summary class="muted">Advanced (Template & OAuth info)</summary>
      <div class="small">
        Template ID (fixed): <span class="mono">1ft0PuCB3EneQ8vW9lFv78c1KBC1giUOGTAmLsa8bETE</span><br/>
        OAuth Client ID: <span class="mono">7010858919-jq4n8blq1b73o26pq3h4n0uk46roqfag.apps.googleusercontent.com</span>
      </div>
    </details>
  </div>

  <div id="log" class="log hidden"></div>
</div>

<!-- Google platform scripts -->
<script async defer src="https://apis.google.com/js/api.js"></script>
<script async defer src="https://accounts.google.com/gsi/client"></script>
<script>
const TEMPLATE_ID = "1ft0PuCB3EneQ8vW9lFv78c1KBC1giUOGTAmLsa8bETE";
const CLIENT_ID   = "7010858919-jq4n8blq1b73o26pq3h4n0uk46roqfag.apps.googleusercontent.com";

const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
function setStatus(msg, cls="muted"){ statusEl.className = "small " + cls; statusEl.textContent = msg; }
function log(msg){ logEl.classList.remove('hidden'); logEl.textContent += msg + "\n"; console.log("[fresh]", msg); }

function pickExcel() {
  return new Promise((resolve)=>{
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = ".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
    inp.style.position = 'fixed'; inp.style.left = '-9999px';
    document.body.appendChild(inp);
    inp.addEventListener('change', ()=> resolve(inp.files && inp.files[0] ? inp.files[0] : null));
    inp.click();
  });
}

async function ensureGapi() {
  setStatus("Loading Google APIs…");
  await new Promise((resolve,reject)=>{ 
    gapi.load("client", async ()=>{ try{ await gapi.client.init({}); resolve(); }catch(e){ reject(e); } }); 
  });
  await gapi.client.load("https://www.googleapis.com/discovery/v1/apis/drive/v3/rest");
  await gapi.client.load("https://sheets.googleapis.com/$discovery/rest?version=v4");
  log("gapi loaded");
}

async function ensureToken() {
  setStatus("Getting Google token…");
  return await new Promise((resolve,reject)=>{
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets",
      use_fedcm_for_prompt: true,
      callback: ()=>{}
    });
    tokenClient.callback = (r)=> r && r.access_token ? resolve(r.access_token) : reject(new Error(r?.error||"No token"));
    tokenClient.requestAccessToken({prompt:"consent"});
  });
}

async function waitReady(id){
  for (let i=1;i<=10;i++){
    try { const r = await gapi.client.sheets.spreadsheets.get({ spreadsheetId:id, fields:"spreadsheetId" }); if (r?.result?.spreadsheetId) return; } catch(_){}
    await new Promise(r=>setTimeout(r, 250*i));
  }
  throw new Error("Google Sheet not ready.");
}

// Upload picked Excel & convert to Google Sheet
async function uploadAndConvertXlsx(blob, name){
  const tokenObj = gapi.client.getToken && gapi.client.getToken();
  const accessToken = tokenObj && tokenObj.access_token ? tokenObj.access_token : null;
  if (!accessToken) throw new Error("Missing access token");

  const metadata = {
    name: name + " (Converted)",
    mimeType: "application/vnd.google-apps.spreadsheet"
  };
  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
  form.append("file", blob, (blob && blob.name) ? blob.name : (name + ".xlsx"));

  const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
    method: "POST",
    headers: { "Authorization": "Bearer " + accessToken },
    body: form
  });
  if (!res.ok){
    const t = await res.text().catch(()=>"(no body)");
    throw new Error("Upload failed: " + res.status + " " + t);
  }
  const json = await res.json();
  log("Converted file id: " + json.id);
  return json.id;
}

async function copyTemplate(name){
  const copyRes = await gapi.client.drive.files.copy({
    fileId: TEMPLATE_ID, supportsAllDrives: true, fields: "id", resource: { name }
  });
  return copyRes.result.id;
}

async function listSheets(spreadsheetId){
  const res = await gapi.client.sheets.spreadsheets.get({
    spreadsheetId, fields:"sheets(properties(sheetId,title,index))"
  });
  return (res.result.sheets||[]).map(s=>s.properties);
}

async function exportFresh(){
  try{
    setStatus("Pick the Excel you just downloaded from Generate…");
    const picked = await pickExcel();
    if (!picked){ setStatus("Canceled (no Excel picked).", "warn"); return; }

    await ensureGapi();
    const token = await ensureToken();
    gapi.client.setToken({access_token: token});

    const baseName = ((document.getElementById("fileName")?.value || "master_output").trim()||"master_output").replace(/\s+/g,"_");
    const gsName = baseName + " (Google Sheet)";
    setStatus("Copying your template…");
    const destId = await copyTemplate(gsName);
    await waitReady(destId);
    log("Template copy id: " + destId);

    setStatus("Uploading & converting Excel…");
    const convertedId = await uploadAndConvertXlsx(picked, baseName);

    setStatus("Copying sheets over…");
    const srcSheets = await listSheets(convertedId);
    for (const s of srcSheets){
      await gapi.client.sheets.spreadsheets.sheets.copyTo({
        spreadsheetId: convertedId, sheetId: s.sheetId,
        resource: { destinationSpreadsheetId: destId }
      });
    }

    // remove any placeholders in the template copy that didn't come from the Excel
    const dstSheets = await listSheets(destId);
    const inserted = new Set(srcSheets.map(s=>s.title));
    const toDelete = dstSheets.filter(p => !inserted.has(p.title));
    if (toDelete.length){
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: destId,
        resource: { requests: toDelete.map(p => ({ deleteSheet: { sheetId: p.sheetId } })) }
      });
    }

    setStatus("Opening Google Sheet…", "ok");
    window.open(`https://docs.google.com/spreadsheets/d/${destId}/edit`, "_blank");
  }catch(e){
    console.error(e);
    setStatus("Export failed: " + (e?.result?.error?.message || e.message || String(e)), "warn");
    alert("Export failed: " + (e?.result?.error?.message || e.message || String(e)));
  }
}

document.getElementById('btnExport').addEventListener('click', function(e){
  e.preventDefault();
  exportFresh();
});
</script>

</body>
</html>